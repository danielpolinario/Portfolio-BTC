<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Investimentos Bitcoin</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            width: 100%;
            background-color: #1e1e1e;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            padding: 25px 30px;
        }
        .header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .header img {
            height: 40px;
            width: auto;
        }
        .header h1 {
            margin: 0;
            border-bottom: none;
            padding-bottom: 0;
            color: #ff9900;
            font-size: 2em;
        }
        h2 {
            color: #ff9900;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }
        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.2em;
            color: #aaa;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
        }
        .card {
            background-color: #2a2a2a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(255, 153, 0, 0.1);
        }
        .card h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #ccc;
            font-size: 1em;
            font-weight: normal;
        }
        /* Valores principais com tamanho maior */
        .card .main-value {
            font-size: 1.8em;
            font-weight: bold;
            margin: 5px 0;
        }
        #current-price { color: #ff9900; }
        #wallet-balance { color: #ffffff; }
        #current-value-brl { color: #4caf50; }
        #total-invested-brl { color: #ffffff; }
        .positive { color: #4caf50; }
        .negative { color: #f44336; }
        #wallet-address {
            font-family: monospace;
            font-size: 0.9em;
            word-break: break-all;
            color: #aaa;
            background-color: #2a2a2a;
            padding: 5px 8px;
            border-radius: 4px;
        }
        .meta-section {
            margin-top: 30px;
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .meta-section input {
            padding: 12px;
            border: 1px solid #444;
            background-color: #333;
            color: #fff;
            border-radius: 4px;
            font-size: 1em;
            width: 220px;
            margin-top: 10px;
        }
        #goal-result {
            margin-top: 15px;
            font-weight: bold;
            font-size: 1.1em;
        }
        .transactions-table-wrapper {
            overflow-x: auto;
        }
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .transactions-table th, .transactions-table td {
            border-bottom: 1px solid #333;
            padding: 12px 10px;
            text-align: left;
        }
        .transactions-table th {
            background-color: #333;
            color: #ff9900;
        }
        .transactions-table tr:nth-child(even) {
            background-color: #242424;
        }
        .transactions-table a {
            color: #ff9900;
            text-decoration: none;
        }
        .transactions-table a:hover {
            text-decoration: underline;
        }
        footer {
            text-align: center;
            margin-top: 40px;
            font-size: 0.8em;
            color: #888;
        }
        /* Estilo para Lucro/Prejuízo */
        .profit-loss-wrapper {
            display: flex;
            flex-direction: column;
        }
        .profit-loss-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .profit-loss-value {
            font-size: 1.8em !important;
            font-weight: bold;
        }
        .profit-loss-percentage {
            font-size: 1.1em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container" id="main-container" style="display:none;">
        <div class="header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/46/Bitcoin.svg/264px-Bitcoin.svg.png" alt="Logo Bitcoin">
            <h1>Painel Bitcoin</h1>
        </div>
        
        <p>Carteira monitorada: <b id="wallet-address">bc1q3nah3kzyy2cj8xmwulf6fjas6zpqn37c6a7lmw</b></p>
        
        <div class="grid-container">
            <div class="card">
                <h3>Cotação Atual (BTC/BRL)</h3>
                <div id="current-price"><div class="main-value">R$ 0,00</div></div>
            </div>
            <div class="card">
                <h3>Saldo na Carteira (BTC)</h3>
                <div id="wallet-balance"><div class="main-value">0.00000000</div></div>
            </div>
            <div class="card">
                <h3>Valor Atual da Carteira</h3>
                <div id="current-value-brl"><div class="main-value">R$ 0,00</div></div>
            </div>
            <div class="card">
                <h3>Total Aportado (Estimado)</h3>
                <div id="total-invested-brl"><div class="main-value">R$ 0,00</div></div>
            </div>
             <div class="card">
                <h3>Lucro / Prejuízo</h3>
                <div id="profit-loss">R$ 0,00</div>
            </div>
        </div>

        <div class="meta-section">
            <h2>Minha Meta</h2>
            <p>Digite sua meta de valor em Reais (BRL) para ver o quanto falta para alcançá-la.</p>
            <input type="number" id="goal-input" placeholder="Ex: 100000">
            <div id="goal-result"></div>
        </div>
        
        <h2>Histórico de Transações</h2>
        <div class="transactions-table-wrapper">
            <table class="transactions-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Tipo</th>
                        <th>Valor (BTC)</th>
                        <th>ID da Transação (TXID)</th>
                    </tr>
                </thead>
                <tbody id="transaction-list">
                    <!-- Transações serão inseridas aqui -->
                </tbody>
            </table>
        </div>

        <footer>
            <p>Dados de transações via API Blockstream.info. Cotações via API CoinGecko.</p>
            <p>Lucro/Prejuízo calculado com base em aportes recentes.</p>
        </footer>
    </div>

    <div class="loading" id="loading-indicator">
        <p>Buscando dados da blockchain e cotações...</p>
        <p>Isso pode levar alguns segundos.</p>
    </div>

    <script>
        // Configurações
        const WALLET_ADDRESS = 'bc1q3nah3kzyy2cj8xmwulf6fjas6zpqn37c6a7lmw';
        const SATOSHIS_PER_BTC = 100_000_000;

        // Elementos
        const ui = {
            currentPrice: document.getElementById('current-price'),
            walletBalance: document.getElementById('wallet-balance'),
            currentValueBRL: document.getElementById('current-value-brl'),
            totalInvestedBRL: document.getElementById('total-invested-brl'),
            profitLoss: document.getElementById('profit-loss'),
            goalInput: document.getElementById('goal-input'),
            goalResult: document.getElementById('goal-result'),
            transactionList: document.getElementById('transaction-list'),
            loadingIndicator: document.getElementById('loading-indicator'),
            mainContainer: document.getElementById('main-container')
        };

        // Formatação
        const formatBRL = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        const formatBTC = (value) => value.toFixed(8);

        // APIs
        async function fetchCurrentPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=brl');
                if (!response.ok) throw new Error('Falha ao buscar preço atual');
                const data = await response.json();
                return data.bitcoin.brl;
            } catch (error) {
                console.error("Erro ao buscar preço atual:", error);
                return 0;
            }
        }

        async function fetchTransactions(address) {
            try {
                const response = await fetch(`https://blockstream.info/api/address/${address}/txs`);
                if (!response.ok) throw new Error('Falha ao buscar transações');
                return await response.json();
            } catch (error) {
                console.error("Erro ao buscar transações:", error);
                return [];
            }
        }

        async function fetchHistoricalPrice(dateString, cache) {
            // Corrige o formato da data para DD-MM-YYYY
            const parts = dateString.split('-');
            const correctedDate = `${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}-${parts[2]}`;
            
            if (cache.has(correctedDate)) return cache.get(correctedDate);
            
            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/coins/bitcoin/history?date=${correctedDate}&localization=false`);
                if (!response.ok) throw new Error(`Status ${response.status}`);
                
                const data = await response.json();
                const price = data.market_data?.current_price?.brl;
                
                if (!price) throw new Error('Preço não disponível');
                
                cache.set(correctedDate, price);
                return price;
                
            } catch (error) {
                console.warn(`Erro ao buscar preço para ${correctedDate}:`, error.message);
                return null;
            }
        }

        // Lógica Principal
        async function initializeDashboard() {
            try {
                const currentBtcPriceBRL = await fetchCurrentPrice();
                const transactions = await fetchTransactions(WALLET_ADDRESS);

                let totalBalanceSatoshis = 0;
                let totalInvestedBRL = 0;
                const historicalPriceCache = new Map();
                
                // Data de corte para aportes (ontem)
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - 1);
                cutoffDate.setHours(0, 0, 0, 0);

                for (const tx of transactions) {
                    if (!tx.status.confirmed) continue;

                    const valueOut = tx.vin.reduce((sum, vin) => 
                        vin.prevout.scriptpubkey_address === WALLET_ADDRESS ? sum + vin.prevout.value : sum, 0);
                    
                    const valueIn = tx.vout.reduce((sum, vout) =>
                        vout.scriptpubkey_address === WALLET_ADDRESS ? sum + vout.value : sum, 0);

                    const netChangeSatoshis = valueIn - valueOut;
                    totalBalanceSatoshis += netChangeSatoshis;

                    const txDate = new Date(tx.status.block_time * 1000);
                    
                    // Só considera aportes recentes
                    if (netChangeSatoshis > 0 && txDate >= cutoffDate) {
                        const dateString = `${txDate.getDate()}-${txDate.getMonth() + 1}-${txDate.getFullYear()}`;
                        const historicalPrice = await fetchHistoricalPrice(dateString, historicalPriceCache);
                        
                        if (historicalPrice) {
                            const investedAmountBRL = (netChangeSatoshis / SATOSHIS_PER_BTC) * historicalPrice;
                            totalInvestedBRL += investedAmountBRL;
                        } else {
                            // Fallback: usa preço atual se histórico falhar
                            totalInvestedBRL += (netChangeSatoshis / SATOSHIS_PER_BTC) * currentBtcPriceBRL;
                            console.log(`Usando preço atual como fallback para transação em ${dateString}`);
                        }
                    }

                    renderTransactionRow(tx, netChangeSatoshis);
                }

                const finalBalanceBTC = totalBalanceSatoshis / SATOSHIS_PER_BTC;
                const currentWalletValueBRL = finalBalanceBTC * currentBtcPriceBRL;
                const profitLoss = currentWalletValueBRL - totalInvestedBRL;

                // Atualiza UI
                updateUI(finalBalanceBTC, currentBtcPriceBRL, currentWalletValueBRL, totalInvestedBRL, profitLoss);

                // Configura meta
                setupGoalListener(currentWalletValueBRL, currentBtcPriceBRL);

            } catch (error) {
                ui.loadingIndicator.innerHTML = `<p>Erro ao carregar dados.</p><p>${error.message}</p>`;
                console.error("Erro no painel:", error);
                return;
            }

            ui.loadingIndicator.style.display = 'none';
            ui.mainContainer.style.display = 'block';
        }

        function updateUI(balance, price, currentValue, invested, profit) {
            ui.currentPrice.innerHTML = `<div class="main-value">${formatBRL(price)}</div>`;
            ui.walletBalance.innerHTML = `<div class="main-value">${formatBTC(balance)}</div>`;
            ui.currentValueBRL.innerHTML = `<div class="main-value">${formatBRL(currentValue)}</div>`;
            ui.totalInvestedBRL.innerHTML = `<div class="main-value">${formatBRL(invested)}</div>`;
            
            // Cálculo da porcentagem
            const percentage = invested !== 0 ? (profit / invested) * 100 : 0;
            const percentageFormatted = percentage.toFixed(2) + '%';
            const isPositive = profit >= 0;
            
            // Atualiza o Lucro/Prejuízo
            ui.profitLoss.innerHTML = `
                <div class="profit-loss-wrapper">
                    <div class="profit-loss-row">
                        <div class="main-value ${isPositive ? 'positive' : 'negative'}">
                            ${formatBRL(profit)}
                        </div>
                    </div>
                    <div class="profit-loss-row">
                        <div class="profit-loss-percentage ${isPositive ? 'positive' : 'negative'}">
                            ${percentageFormatted}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTransactionRow(tx, netChangeSatoshis) {
            const row = ui.transactionList.insertRow(0);
            const type = netChangeSatoshis > 0 ? 'Entrada' : 'Saída';
            const btcValue = formatBTC(Math.abs(netChangeSatoshis) / SATOSHIS_PER_BTC);
            
            row.innerHTML = `
                <td>${new Date(tx.status.block_time * 1000).toLocaleDateString('pt-BR')}</td>
                <td class="${type === 'Entrada' ? 'positive' : 'negative'}">${type}</td>
                <td>${btcValue} BTC</td>
                <td><a href="https://mempool.space/tx/${tx.txid}" target="_blank">${tx.txid.substring(0, 10)}...</a></td>
            `;
        }

        function setupGoalListener(currentWalletValueBRL, currentBtcPriceBRL) {
            ui.goalInput.addEventListener('input', () => {
                const goalValue = parseFloat(ui.goalInput.value) || 0;
                
                if (goalValue <= 0) {
                    ui.goalResult.textContent = '';
                    return;
                }
                
                if (currentWalletValueBRL >= goalValue) {
                    ui.goalResult.textContent = '🎉 Meta alcançada!';
                    ui.goalResult.className = 'positive';
                } else {
                    const neededBRL = goalValue - currentWalletValueBRL;
                    const neededBTC = neededBRL / currentBtcPriceBRL;
                    ui.goalResult.textContent = `Faltam ${formatBRL(neededBRL)} (${formatBTC(neededBTC)} BTC)`;
                    ui.goalResult.className = '';
                }
            });
        }

        window.onload = initializeDashboard;
    </script>
</body>
</html>
