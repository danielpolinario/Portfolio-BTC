<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle Bitcoin (BTC)</title>
    
    <!-- Incluindo Chart.js para os gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-color: #1a1a2e;
            --card-color: #16213e;
            --font-color: #e0e0e0;
            --primary-color: #f7931a;
            --green-color: #03c04a;
            --red-color: #ff4757;
            --border-color: #0f3460;
            --profit-color: #03c04a;
            --loss-color: #ff4757;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--font-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        header {
            grid-column: 1 / -1;
            text-align: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 10px;
        }

        header img {
            max-width: 150px;
            margin-bottom: 15px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        header h1 {
            margin: 0;
            color: var(--primary-color);
        }
        
        header p {
            margin-top: 5px;
            font-size: 0.9em;
            opacity: 0.7;
        }

        .card {
            background-color: var(--card-color);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 15px;
        }

        .metric {
            text-align: center;
        }

        .metric .label {
            font-size: 0.9em;
            opacity: 0.8;
            min-height: 30px;
        }

        .metric .value {
            font-size: 1.6em;
            font-weight: bold;
            margin-top: 5px;
        }

        #patrimonio-atual {
            color: var(--green-color);
        }

        .progress-bar-container {
            width: 100%;
            background-color: var(--bg-color);
            border-radius: 5px;
            margin-top: 15px;
        }

        #progress-bar {
            width: 0%;
            height: 20px;
            background-color: var(--green-color);
            border-radius: 5px;
            text-align: center;
            line-height: 20px;
            color: white;
            font-weight: bold;
            transition: width 0.5s ease-in-out;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--font-color);
        }

        button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #d97e15;
        }

        .danger-button {
            background-color: var(--red-color);
            margin-top: 15px;
        }
        .danger-button:hover {
            background-color: #c93a47;
        }

        #transaction-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        #transaction-table th, #transaction-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        #transaction-table th {
            font-size: 0.9em;
            color: var(--primary-color);
        }
        
        #transaction-table td {
            font-size: 0.95em;
        }

        .profit {
            color: var(--profit-color);
        }

        .loss {
            color: var(--loss-color);
        }

        footer {
            grid-column: 1 / -1;
            text-align: center;
            font-size: 0.8em;
            opacity: 0.6;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        /* Estilo para o gr√°fico */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .chart-values {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .chart-value {
            font-weight: bold;
        }

        .chart-dates {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.8em;
            opacity: 0.7;
        }

        /* Campo de meta */
        #meta-input {
            width: 200px;
            padding: 8px;
            margin: 10px 0;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--font-color);
        }

        /* Layout de duas colunas para o formul√°rio e hist√≥rico */
        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .auto-value-info {
            color: var(--primary-color);
            font-size: 0.9em;
            padding: 8px;
            background: rgba(15, 52, 96, 0.3);
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        @media (max-width: 768px) {
            .two-columns {
                grid-template-columns: 1fr;
            }
        }
    
    /* NOVO: Estilos para celulares menores */
    @media (max-width: 480px) {
        header p {
            display: block;
            font-size: 0.85em;
            text-align: center;
        }

        #meta-input {
            width: 100%;
        }

        .dashboard-grid {
            grid-template-columns: 1fr;
        }

        .metric .label {
            font-size: 0.85em;
        }

        .metric .value {
            font-size: 1.4em;
        }

        .card h2 {
            font-size: 1.1em;
        }

        .form-group input,
        .form-group select {
            font-size: 1em;
        }

        button {
            font-size: 1em;
            padding: 10px;
        }

        .chart-container {
            height: 250px;
        }

        header img {
            max-width: 120px;
        }
    }

</style>
</head>
<body>

    <div class="container">
        <header>
            <img src="https://logospng.org/download/bitcoin/logo-bitcoin-4096.png" alt="Logo Bitcoin">
            <h1>Painel de Controle de Investimentos em Bitcoin (BTC)</h1>
            <p>Seu caminho para a meta de <input type="number" id="meta-input" value="150000" min="0" step="100">, atualizado em tempo real.</p>
            <div id="live-price" style="font-size:1.1em; margin-top:10px;">Buscando cota√ß√µes...</div>
        </header>

        <div class="card" style="grid-column: 1 / -1;">
            <h2>Dashboard Principal</h2>
            <div class="dashboard-grid">
                <div class="metric">
                    <div class="label">Total de BTC Acumulado</div>
                    <div class="value" id="total-btc">0.00000000</div>
                </div>
                <div class="metric">
                    <div class="label">Patrim√¥nio Atual (R$)</div>
                    <div class="value" id="patrimonio-atual">R$ 0,00</div>
                </div>
                <div class="metric">
                    <div class="label">Pre√ßo M√©dio de Compra (R$)</div>
                    <div class="value" id="preco-medio">R$ 0,00</div>
                </div>
                <div class="metric">
                    <div class="label">Falta para a Meta (R$)</div>
                    <div class="value" id="falta-para-meta">R$ 150.000,00</div>
                </div>
                <div class="metric">
                    <div class="label">BTC Necess√°rios para Meta</div>
                    <div class="value" id="btc-para-meta">...</div>
                </div>
                <div class="metric">
                    <div class="label">Total Investido (R$)</div>
                    <div class="value" id="total-investido">R$ 0,00</div>
                </div>
                <div class="metric">
                    <div class="label">Lucro/Preju√≠zo Total</div>
                    <div class="value" id="profit-loss">-</div>
                </div>
            </div>
            <h3 id="progress-title" style="text-align:center; margin-top: 25px; margin-bottom:10px;">Progresso at√© a Meta (R$ 150.000)</h3>
            <div class="progress-bar-container">
                <div id="progress-bar">0%</div>
            </div>
        </div>

        <div class="two-columns" style="grid-column: 1 / -1;">
            <div class="card">
                <h2>Adicionar Lan√ßamento</h2>
                <form id="transaction-form">
                    <div class="form-group">
                        <label for="date">Data da Opera√ß√£o</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label for="btc-amount">Quantidade de BTC</label>
                        <input type="number" id="btc-amount" step="any" placeholder="Ex: 0.005" required>
                    </div>
                    <div class="form-group" id="brl-value-group">
                        <label for="brl-value">Valor Total (R$)</label>
                        <input type="number" id="brl-value" step="any" placeholder="Ex: 1000.00" required>
                    </div>
                    <div id="auto-value-info" class="auto-value-info">
                        O valor ser√° calculado automaticamente pela cota√ß√£o atual (1 BTC = R$<span id="current-price-span">0.00</span>)
                    </div>
                    <div class="form-group">
                        <label for="operation-type">Tipo de Opera√ß√£o</label>
                        <select id="operation-type">
                            <option value="buy">Compra</option>
                            <option value="sell">Venda</option>
                        </select>
                    </div>
                    <button type="submit">Confirmar Opera√ß√£o</button>
                </form>
                <button class="danger-button" id="reset-button">Limpar Todos os Dados</button>
            </div>

            <div class="card">
                <h2>Hist√≥rico de Compras e Vendas</h2>
                <div style="max-height: 300px; overflow-y: auto;">
                    <table id="transaction-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Qtd. BTC</th>
                                <th>Valor (R$)</th>
                                <th>Tipo</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card" style="grid-column: 1 / -1;">
            <h2>Evolu√ß√£o do Patrim√¥nio</h2>
            <div class="chart-container">
                <canvas id="portfolio-chart"></canvas>
            </div>
            <div class="chart-values">
                <!-- Valores ser√£o preenchidos dinamicamente pelo JavaScript -->
            </div>
            <div class="chart-dates">
                <span id="start-date">-</span>
                <span id="end-date">-</span>
            </div>
        </div>

        <footer>
            <p>Os dados de lan√ßamento s√£o salvos localmente no seu navegador. As cota√ß√µes s√£o fornecidas pela API da CoinGecko e atualizadas a cada hora.</p>
            <p>Isto n√£o √© uma recomenda√ß√£o de investimento.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Elementos do DOM
            const totalBtcEl = document.getElementById('total-btc');
            const patrimonioAtualEl = document.getElementById('patrimonio-atual');
            const precoMedioEl = document.getElementById('preco-medio');
            const totalInvestidoEl = document.getElementById('total-investido');
            const progressBarEl = document.getElementById('progress-bar');
            const progressTitleEl = document.getElementById('progress-title');
            const transactionForm = document.getElementById('transaction-form');
            const transactionListEl = document.getElementById('transaction-list');
            const livePriceEl = document.getElementById('live-price');
            const faltaParaMetaEl = document.getElementById('falta-para-meta');
            const btcParaMetaEl = document.getElementById('btc-para-meta');
            const profitLossEl = document.getElementById('profit-loss');
            const metaInputEl = document.getElementById('meta-input');
            const chartValuesContainer = document.querySelector('.chart-values');
            const brlValueGroup = document.getElementById('brl-value-group');
            const brlValueInput = document.getElementById('brl-value');
            const operationTypeSelect = document.getElementById('operation-type');
            const autoValueInfo = document.getElementById('auto-value-info');
            const currentPriceSpan = document.getElementById('current-price-span');
            const startDateEl = document.getElementById('start-date');
            const endDateEl = document.getElementById('end-date');

            // Estado da aplica√ß√£o
            let transactions = JSON.parse(localStorage.getItem('btc_transactions')) || [];
            let btcPrice = { usd: 0, brl: 0 };
            let metaBRL = 150000;
            let portfolioChart;

            // Inicializar gr√°fico
            const ctx = document.getElementById('portfolio-chart').getContext('2d');
            initializeChart();

            // Configurar listener para o tipo de opera√ß√£o
            operationTypeSelect.addEventListener('change', function() {
                if (this.value === 'sell') {
                    brlValueGroup.style.display = 'none';
                    brlValueInput.removeAttribute('required');
                    autoValueInfo.style.display = 'block';
                    currentPriceSpan.textContent = btcPrice.brl.toFixed(2);
                } else {
                    brlValueGroup.style.display = 'block';
                    brlValueInput.setAttribute('required', '');
                    autoValueInfo.style.display = 'none';
                }
            });

            // Fun√ß√µes
            async function fetchPrices() {
                try {
                    const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd,brl');
                    if (!response.ok) throw new Error('Erro de rede ao buscar cota√ß√£o.');
                    const data = await response.json();
                    btcPrice.usd = data.bitcoin.usd;
                    btcPrice.brl = data.bitcoin.brl;
                    livePriceEl.textContent = `Cota√ß√£o Atual: 1 BTC = $${btcPrice.usd.toLocaleString('en-US', {maximumFractionDigits: 2})} USD / R$${btcPrice.brl.toLocaleString('pt-BR', {maximumFractionDigits: 2})} BRL`;
                    
                    // Atualiza o pre√ßo mostrado no aviso de valor autom√°tico
                    if (operationTypeSelect.value === 'sell') {
                        currentPriceSpan.textContent = btcPrice.brl.toLocaleString('pt-BR', {maximumFractionDigits: 2});
                    }
                    
                    updateUI();
                } catch (error) {
                    livePriceEl.textContent = 'Erro ao buscar cota√ß√£o. Tentando novamente em breve...';
                    console.error("API Error:", error);
                }
            }

            function updateUI() {
                // Atualiza a meta se foi alterada
                metaBRL = parseFloat(metaInputEl.value) || 150000;
                progressTitleEl.textContent = `Progresso at√© a Meta (${formatCurrencyBRL(metaBRL)})`;

                // Calcula totais
                const totalBTC = transactions.reduce((sum, t) => sum + (t.type === 'buy' ? t.btc : -t.btc), 0);
                const totalInvested = transactions.reduce((sum, t) => sum + (t.type === 'buy' ? t.brl : -t.brl), 0);
                const patrimonioAtual = totalBTC * btcPrice.brl;
                const precoMedio = totalBTC > 0 ? totalInvested / totalBTC : 0;
                
                // Atualiza os valores na tela
                totalBtcEl.textContent = totalBTC.toFixed(8);
                totalInvestidoEl.textContent = formatCurrencyBRL(totalInvested);
                patrimonioAtualEl.textContent = formatCurrencyBRL(patrimonioAtual);
                precoMedioEl.textContent = formatCurrencyBRL(precoMedio);

                // Calcula progresso
                const progress = (patrimonioAtual / metaBRL) * 100;
                progressBarEl.style.width = `${Math.min(progress, 100)}%`;
                progressBarEl.textContent = `${progress.toFixed(2)}%`;

                // Calcula quanto falta para a meta
                const faltaParaMeta = Math.max(0, metaBRL - patrimonioAtual);
                faltaParaMetaEl.textContent = formatCurrencyBRL(faltaParaMeta);

                // Calcula BTC necess√°rios para atingir a meta
                if (faltaParaMeta <= 0) {
                    btcParaMetaEl.textContent = "üéâ Meta Atingida!";
                    btcParaMetaEl.style.color = '#ffd700';
                } else if (btcPrice.brl > 0) {
                    const btcNecessarios = faltaParaMeta / btcPrice.brl;
                    btcParaMetaEl.textContent = `${btcNecessarios.toFixed(8)} BTC`;
                    btcParaMetaEl.style.color = 'var(--primary-color)';
                } else {
                    btcParaMetaEl.textContent = "Cota√ß√£o indispon√≠vel";
                    btcParaMetaEl.style.color = 'var(--font-color)';
                }

                // Calcula lucro/preju√≠zo
                const profitLoss = patrimonioAtual - totalInvested;
                let profitLossPercentage = 0;
                if (totalInvested > 0) {
                    profitLossPercentage = (profitLoss / totalInvested) * 100;
                }

                profitLossEl.textContent = `${formatCurrencyBRL(profitLoss)} (${profitLossPercentage.toFixed(2)}%)`;
                if (profitLoss >= 0) {
                    profitLossEl.classList.remove('loss');
                    profitLossEl.classList.add('profit');
                } else {
                    profitLossEl.classList.remove('profit');
                    profitLossEl.classList.add('loss');
                }

                // Atualiza a lista de transa√ß√µes
                renderTransactionList();
                
                // Atualiza o gr√°fico
                updateChart();
            }

            function renderTransactionList() {
                transactionListEl.innerHTML = '';
                
                transactions.slice().reverse().forEach(t => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(t.date).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</td>
                        <td>${t.btc.toFixed(8)}</td>
                        <td>${formatCurrencyBRL(t.brl)}</td>
                        <td>${t.type === 'buy' ? 'Compra' : 'Venda'}</td>
                    `;
                    transactionListEl.appendChild(row);
                });
            }

            function initializeChart() {
                portfolioChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Patrim√¥nio (R$)',
                            data: [],
                            borderColor: '#f7931a',
                            backgroundColor: 'rgba(247, 147, 26, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return `Patrim√¥nio: ${formatCurrencyBRL(context.raw)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)',
                                    callback: function(value) {
                                        return formatCurrencyBRL(value);
                                    }
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });
            }

            function updateChart() {
                if (transactions.length === 0) {
                    portfolioChart.data.labels = [];
                    portfolioChart.data.datasets[0].data = [];
                    portfolioChart.update();
                    
                    // Limpa os valores e datas exibidos
                    chartValuesContainer.innerHTML = '';
                    startDateEl.textContent = '-';
                    endDateEl.textContent = '-';
                    return;
                }

                // Ordena transa√ß√µes por data
                const sortedTransactions = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Calcula o patrim√¥nio acumulado ao longo do tempo
                let cumulativeBTC = 0;
                let cumulativeInvested = 0;
                const dates = [];
                const portfolioValues = [];
                
                // Adiciona pontos para cada transa√ß√£o
                sortedTransactions.forEach((t) => {
                    cumulativeBTC += t.type === 'buy' ? t.btc : -t.btc;
                    cumulativeInvested += t.type === 'buy' ? t.brl : -t.brl;
                    
                    // Usamos o pre√ßo atual para calcular o patrim√¥nio (simplifica√ß√£o)
                    const portfolioValue = cumulativeBTC * btcPrice.brl;
                    
                    dates.push(new Date(t.date).toLocaleDateString('pt-BR'));
                    portfolioValues.push(portfolioValue);
                });
                
                // Adiciona um ponto com a data atual se houver transa√ß√µes
                if (sortedTransactions.length > 0) {
                    dates.push(new Date().toLocaleDateString('pt-BR'));
                    const currentBTC = transactions.reduce((sum, t) => sum + (t.type === 'buy' ? t.btc : -t.btc), 0);
                    const currentValue = currentBTC * btcPrice.brl;
                    portfolioValues.push(currentValue);
                }
                
                // Atualiza o gr√°fico
                portfolioChart.data.labels = dates;
                portfolioChart.data.datasets[0].data = portfolioValues;
                portfolioChart.update();
                
                // Atualiza os valores exibidos abaixo do gr√°fico
                updateChartValues(portfolioValues);
                
                // Atualiza as datas exibidas
                if (dates.length > 0) {
                    startDateEl.textContent = dates[0];
                    endDateEl.textContent = dates[dates.length - 1];
                }
            }

            function updateChartValues(values) {
                // Limpa os valores anteriores
                chartValuesContainer.innerHTML = '';
                
                // Adiciona os novos valores
                values.forEach(value => {
                    const valueEl = document.createElement('div');
                    valueEl.className = 'chart-value';
                    valueEl.textContent = formatCurrencyBRL(value);
                    chartValuesContainer.appendChild(valueEl);
                });
            }

            function addTransaction(e) {
                e.preventDefault();
                const date = document.getElementById('date').value;
                const btcAmount = parseFloat(document.getElementById('btc-amount').value);
                const operationType = document.getElementById('operation-type').value;
                
                let brlValue;
                
                if (operationType === 'sell') {
                    // Para vendas, calcula automaticamente pelo pre√ßo do dia
                    brlValue = btcAmount * btcPrice.brl;
                } else {
                    // Para compras, pega o valor do input
                    brlValue = parseFloat(document.getElementById('brl-value').value);
                }

                if (date && btcAmount > 0 && (operationType === 'buy' ? brlValue > 0 : true)) {
                    transactions.push({ 
                        date, 
                        btc: btcAmount, 
                        brl: brlValue,
                        type: operationType 
                    });
                    saveTransactions();
                    updateUI();
                    transactionForm.reset();
                    document.getElementById('date').valueAsDate = new Date();
                    
                    // Restaura o campo de valor para compras futuras
                    if (operationType === 'sell') {
                        brlValueGroup.style.display = 'block';
                        brlValueInput.setAttribute('required', '');
                        autoValueInfo.style.display = 'none';
                    }
                } else {
                    alert('Por favor, preencha todos os campos corretamente.');
                }
            }

            function saveTransactions() {
                localStorage.setItem('btc_transactions', JSON.stringify(transactions));
            }

            function resetAllData() {
                const isConfirmed = confirm('Voc√™ tem certeza que deseja apagar TODO o hist√≥rico de lan√ßamentos? Esta a√ß√£o n√£o pode ser desfeita.');
                if (isConfirmed) {
                    localStorage.removeItem('btc_transactions');
                    transactions = [];
                    updateUI();
                    alert('Hist√≥rico apagado com sucesso!');
                }
            }

            function formatCurrencyBRL(value) {
                return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }

            // Event Listeners
            transactionForm.addEventListener('submit', addTransaction);
            metaInputEl.addEventListener('change', updateUI);
            document.getElementById('reset-button').addEventListener('click', resetAllData);

            // Configura a data atual como padr√£o para o formul√°rio
            document.getElementById('date').valueAsDate = new Date();

            // Inicializa a aplica√ß√£o
            fetchPrices();
            setInterval(fetchPrices, 3600 * 1000);
            updateUI();
        });
    </script>
</body>
</html>